<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <link rel="icon" href="logo.png" type="image/png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Notas Fiscais</title>

    <style>
        /* Vari√°veis CSS (LIGHT MODE - PADR√ÉO) */
        :root {
            --cor-principal: #1e88e5;
            /* Azul vibrante */
            --cor-secundaria: #4caf50;
            /* Verde para sucesso */
            --cor-fundo: #f0f4f8;
            --cor-card: #ffffff;
            --cor-texto: #333333;
            --cor-texto-claro: #555555;
            --cor-borda: #c0c0c0;
            --cor-cabecalho-tabela: #e3f2fd;
            --sombra-card: 0 6px 15px rgba(0, 0, 0, 0.1);
            --borda-raio: 10px;
        }

        /* DARK MODE - Sobrescreve as vari√°veis */
        body.dark-mode {
            --cor-principal: #64b5f6;
            --cor-secundaria: #81c784;
            --cor-fundo: #1e1e1e;
            --cor-card: #2c2c2c;
            --cor-texto: #e0e0e0;
            --cor-texto-claro: #aaaaaa;
            --cor-borda: #444444;
            --cor-cabecalho-tabela: #3a3a3a;
            --sombra-card: 0 6px 15px rgba(0, 0, 0, 0.4);
        }

        /* ESTILOS GERAIS */
        body {
            font-family: 'Roboto', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--cor-fundo);
            color: var(--cor-texto);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            width: 100%;
            max-width: 1100px;
            display: flex;
            gap: 25px;
            flex-wrap: wrap;
        }

        .painel,
        .pre-visualizacao {
            background-color: var(--cor-card);
            padding: 30px;
            border-radius: var(--borda-raio);
            box-shadow: var(--sombra-card);
            flex: 1 1 500px;
            min-width: 300px;
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        h1,
        h2 {
            color: var(--cor-principal);
            border-bottom: 3px solid var(--cor-principal);
            padding-bottom: 10px;
            margin-bottom: 25px;
            font-weight: 400;
            font-size: 1.5em;
        }

        .painel h2 {
            font-size: 1.3em;
            margin-top: 40px;
        }

        /* Formul√°rio e Inputs */
        .campo {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.95em;
            color: var(--cor-texto-claro);
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        /* Adicionado type="date" */
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--cor-borda);
            border-radius: 5px;
            box-sizing: border-box;
            transition: border-color 0.3s;
            font-size: 1em;
            background-color: var(--cor-card);
            color: var(--cor-texto);
        }

        input:focus,
        textarea:focus {
            border-color: var(--cor-principal);
            box-shadow: 0 0 0 1px var(--cor-principal);
            outline: none;
        }

        /* Bot√µes de A√ß√£o */
        .botoes-acao {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 700;
            transition: background-color 0.3s, opacity 0.3s;
        }

        .btn-principal {
            background-color: var(--cor-principal);
            color: white;
            flex-grow: 1;
        }

        .btn-secundario {
            background-color: #9e9e9e;
            color: white;
        }

        .btn-principal:hover,
        .btn-secundario:hover {
            opacity: 0.9;
        }

        /* Tabela Din√¢mica de Itens */
        .tabela-itens {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.95em;
        }

        .tabela-itens thead th {
            padding: 10px;
            background-color: var(--cor-cabecalho-tabela);
            border: 1px solid var(--cor-borda);
            color: var(--cor-texto);
            font-weight: 600;
        }

        body.dark-mode .tabela-itens thead th {
            color: var(--cor-texto);
        }

        #lista-itens tr {
            background-color: var(--cor-card);
        }

        #lista-itens td {
            padding: 10px;
            border: 1px solid var(--cor-borda);
            color: var(--cor-texto);
            vertical-align: middle;
        }

        .btn-remover {
            background: none;
            border: none;
            color: #f44336;
            cursor: pointer;
            padding: 0;
            font-size: 1.2em;
            opacity: 0.8;
        }

        .btn-remover:hover {
            opacity: 1;
        }

        .btn-adicionar {
            background-color: var(--cor-principal);
            color: white;
            padding: 10px 20px;
            font-weight: 500;
        }

        /* Layout de Adi√ß√£o de Item */
        .input-novo-item {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 15px;
            margin-bottom: 25px;
        }

        .input-novo-item input[type="text"] {
            flex-grow: 1;
        }

        .input-novo-item input[type="number"] {
            width: 100px;
            text-align: right;
        }

        .input-novo-item .valor-unitario {
            width: 120px;
            text-align: right;
        }

        /* PR√â-VISUALIZA√á√ÉO DO PDF (Manter visual LIGHT para o PDF final) */
        #relatorio-pdf {
            padding: 25px;
            margin-top: 10px;
            background-color: white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            color: #333;
        }

        /* Garantindo que os estilos internos do PDF sejam Light Mode */
        #relatorio-pdf * {
            color: #333 !important;
            border-color: #ddd !important;
        }

        #relatorio-pdf .cabecalho-relatorio h3 {
            color: #1e88e5 !important;
        }

        #relatorio-pdf .secao h4 {
            color: #555 !important;
            border-left-color: #4caf50 !important;
        }

        #relatorio-pdf .detalhes-itens-pdf th {
            background-color: #e3f2fd !important;
        }

        #relatorio-pdf .total-final {
            color: #1e88e5 !important;
        }

        /* Toggle de Tema */
        .theme-toggle-container {
            position: absolute;
            top: 20px;
            right: 20px;
        }

        .theme-toggle {
            background: #9e9e9e;
            color: white;
            padding: 8px 12px;
            font-weight: 500;
            font-size: 0.9em;
        }

        .theme-toggle:hover {
            background: #757575;
        }

        /* Responsividade */
        @media (max-width: 1100px) {
            .container {
                flex-direction: column;
            }
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .painel,
            .pre-visualizacao {
                padding: 20px;
            }

            .botoes-acao {
                flex-direction: column;
            }

            .theme-toggle-container {
                top: 10px;
                right: 10px;
            }

            .input-novo-item {
                flex-direction: column;
            }

            .input-novo-item input[type="number"],
            .input-novo-item .valor-unitario {
                width: 100%;
                text-align: left;
            }

            .btn-adicionar {
                width: 100%;
            }
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <script>const jsPDF = window.jspdf.jsPDF;</script>

</head>

<body>

    <div class="theme-toggle-container">
        <button class="theme-toggle" onclick="toggleTheme()" id="theme-button">
            Mudar para Dark Mode
        </button>
    </div>

    <div class="container">

        <div class="painel">
            <h1>Configura√ß√£o do Documento</h1>

            <form id="formulario-nota">
                <div class="campo">
                    <label for="tipo">Tipo de Documento:</label>
                    <input type="text" id="tipo" placeholder="Ex: NOTA DE SERVI√áO, FATURA, OR√áAMENTO"
                        oninput="atualizarRelatorio()">
                </div>

                <div class="campo">
                    <label for="numero">N¬∫ Documento:</label>
                    <input type="text" id="numero" placeholder="Ex: 2025/0001, 11103942" oninput="atualizarRelatorio()">
                </div>

                <div class="campo">
                    <label for="data">Data de Emiss√£o:</label>
                    <input type="date" id="data" onchange="atualizarRelatorio()">
                </div>
                <div class="campo">
                    <label for="cliente">Nome do Cliente:</label>
                    <input type="text" id="cliente" placeholder="Ex: Cliente Padr√£o S.A."
                        oninput="atualizarRelatorio()">
                </div>

                <div class="campo">
                    <label for="enderecoCliente">Endere√ßo do Cliente:</label>
                    <input type="text" id="enderecoCliente" placeholder="Ex: Av. Principal, 123, Centro"
                        oninput="atualizarRelatorio()">
                </div>
                <div class="campo">
                    <label for="cpfCliente">CPF/CNPJ do Cliente (Opcional):</label>
                    <input type="text" id="cpfCliente" placeholder="Ex: 000.000.000-00 ou 00.000.000/0001-00"
                        oninput="atualizarRelatorio()">
                </div>
                <div class="campo">
                    <label for="emissor">Nome do Emissor:</label>
                    <input type="text" id="emissor" placeholder="Ex: Sua Empresa LTDA" oninput="atualizarRelatorio()">
                </div>

                <div class="campo">
                    <label for="cnpjEmissor">CNPJ do Emissor:</label>
                    <input type="text" id="cnpjEmissor" placeholder="Ex: 00.000.000/0001-00" oninput="atualizarRelatorio()">
                </div>
                <h2>Itens do Documento</h2>
                <div id="div-itens">
                    <table class="tabela-itens">
                        <thead>
                            <tr>
                                <th>Descri√ß√£o</th>
                                <th style="width: 15%;">Qtd</th>
                                <th style="width: 20%;">V. Unit√°rio</th>
                                <th style="width: 10%;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="lista-itens">
                        </tbody>
                    </table>
                </div>
                <div id="confirmacao-dinamica"
                    style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background-color:var(--cor-card); padding:20px; box-shadow:var(--sombra-card); border-radius:10px; z-index:1000;">
                    <p id="texto-confirmacao">Deseja realmente limpar todos os dados?</p>
                    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
                        <button id="btn-confirmar" class="btn-principal">Sim</button>
                        <button id="btn-cancelar" class="btn-secundario">N√£o</button>
                    </div>
                </div>
                <div class="input-novo-item">
                    <input type="text" id="novo-descricao" placeholder="Descri√ß√£o do Item/Servi√ßo">
                    <input type="number" id="novo-qtd" value="1" min="1">
                    <input type="number" id="novo-valor" value="0.00" min="0" step="0.01" class="valor-unitario">
                    <button type="button" class="btn-adicionar" onclick="adicionarItem()">Adicionar Item</button>
                </div>


                <div class="campo">
                    <label for="imposto-percentual">Imposto (%) - Ex: 10 para 10%</label>
                    <input type="number" id="imposto-percentual" placeholder="Valor em %" min="0" step="0.01"
                        oninput="atualizarRelatorio()">
                </div>

                <div class="botoes-acao">
                    <button type="button" class="btn-principal" onclick="gerarPDF()">
                        Gerar e Baixar PDF
                    </button>
                    <button type="button" class="btn-secundario" onclick="limparTudo()">
                        Limpar Tudo
                    </button>
                </div>
            </form>
        </div>

        <div class="pre-visualizacao">
            <h2>Pr√©-visualiza√ß√£o do Documento</h2>

            <div id="relatorio-pdf">
            </div>
        </div>
    </div>

    <script>
        // Array global para armazenar os itens
        let itens = []; // Inicia vazio
        let proximoId = 1;

        // Chaves para armazenamento local
        const STORAGE_KEY = 'pdfGeneratorDataV2';
        const THEME_KEY = 'themePreferenceV2';

        // Dados gen√©ricos para inicializa√ß√£o (somente se n√£o houver dados salvos)
        const DADOS_GENERICOS = {
            tipo: "NOTA DE SERVI√áO",
            numero: "2025/0001",
            data: new Date().toISOString().substring(0, 10), // Data de hoje em formato YYYY-MM-DD
            cliente: "Cliente Padr√£o S.A.",
            enderecoCliente: "Av. Principal, 123, Centro",
            cpfCliente: "000.000.000-00",
            emissor: "Sua Empresa LTDA",
            cnpjEmissor: "00.000.000/0001-00",
            imposto: "10",
            itens: [],
            proximoId: 1
        };


        // --- Fun√ß√µes de Tema (Dark/Light Mode) ---

        function aplicarTema(tema) {
            const body = document.body;
            const button = document.getElementById('theme-button');

            if (tema === 'dark') {
                body.classList.add('dark-mode');
                button.textContent = 'Mudar para Light Mode';
                localStorage.setItem(THEME_KEY, 'dark');
            } else {
                body.classList.remove('dark-mode');
                button.textContent = 'Mudar para Dark Mode';
                localStorage.setItem(THEME_KEY, 'light');
            }
        }

        function toggleTheme() {
            const temaAtual = localStorage.getItem(THEME_KEY);
            const novoTema = temaAtual === 'dark' ? 'light' : 'dark';
            aplicarTema(novoTema);
        }

        function carregarTema() {
            const temaSalvo = localStorage.getItem(THEME_KEY) || 'light';
            aplicarTema(temaSalvo);
        }

        // --- Fun√ß√µes de L√≥gica de C√°lculo e Visualiza√ß√£o ---

        const formatarMoeda = (valor) => {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL',
            }).format(valor);
        };

        const formatarDataBR = (dataISO) => {
            if (!dataISO) return '';
            const [year, month, day] = dataISO.split('-');
            return `${day}/${month}/${year}`;
        }

        function getDadosDocumento() {
            const subtotal = itens.reduce((acc, item) => acc + (item.quantidade * item.valorUnitario), 0);
            const impostoPercentual = parseFloat(document.getElementById('imposto-percentual').value || 0);
            const valorImposto = subtotal * (impostoPercentual / 100);
            const totalGeral = subtotal + valorImposto;

            return {
                tipo: document.getElementById('tipo').value || DADOS_GENERICOS.tipo.toUpperCase(),
                numero: document.getElementById('numero').value || 'N√ÉO INFORMADO',
                dataISO: document.getElementById('data').value,
                dataDisplay: formatarDataBR(document.getElementById('data').value) || 'N√ÉO INFORMADA',
                cliente: document.getElementById('cliente').value || 'N√ÉO INFORMADO',
                enderecoCliente: document.getElementById('enderecoCliente').value || 'N√ÉO INFORMADO',
                cpfCliente: document.getElementById('cpfCliente').value || 'N√ÉO INFORMADO',
                emissor: document.getElementById('emissor').value || 'N√ÉO INFORMADO',
                cnpjEmissor: document.getElementById('cnpjEmissor').value || 'N√ÉO INFORMADO',
                impostoPercentual: impostoPercentual,
                subtotal: subtotal,
                valorImposto: valorImposto,
                totalGeral: totalGeral,
                dataAtual: new Date().toLocaleDateString('pt-BR')
            };
        }


        function renderizarListaItens() {
            const listaItensEl = document.getElementById('lista-itens');
            listaItensEl.innerHTML = '';

            itens.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.descricao}</td>
                    <td style="text-align: right;">${item.quantidade}</td>
                    <td style="text-align: right;">${formatarMoeda(item.valorUnitario)}</td>
                    <td style="text-align: center;">
                        <button type="button" class="btn-remover" onclick="removerItem(${item.id})">üóëÔ∏è</button>
                    </td>
                `;
                listaItensEl.appendChild(row);
            });

            atualizarRelatorio();
            salvarDados();
        }

        function adicionarItem() {
            const descricao = document.getElementById('novo-descricao').value.trim();
            const quantidade = parseFloat(document.getElementById('novo-qtd').value);
            const valorUnitario = parseFloat(document.getElementById('novo-valor').value);

            if (descricao && quantidade > 0 && valorUnitario >= 0) {
                itens.push({
                    id: proximoId++,
                    descricao: descricao,
                    quantidade: quantidade,
                    valorUnitario: valorUnitario
                });

                document.getElementById('novo-descricao').value = '';
                document.getElementById('novo-qtd').value = '1';
                document.getElementById('novo-valor').value = '0.00';

                renderizarListaItens();
            } else {
                alert("Por favor, preencha todos os campos do item corretamente.");
            }
        }

        function removerItem(id) {
            itens = itens.filter(item => item.id !== id);
            renderizarListaItens();
        }

        function atualizarRelatorio() {
            const dados = getDadosDocumento();
            let itensHTML = '';

            itens.forEach(item => {
                const totalItem = item.quantidade * item.valorUnitario;
                itensHTML += `
                    <tr>
                        <td style="color:#333; padding: 8px; border: 1px solid #ddd;">${item.descricao}</td>
                        <td style="color:#333; text-align: right; padding: 8px; border: 1px solid #ddd;">${item.quantidade}</td>
                        <td style="text-align: right; color:#333; padding: 8px; border: 1px solid #ddd;">${formatarMoeda(item.valorUnitario)}</td>
                        <td style="text-align: right; color:#333; padding: 8px; border: 1px solid #ddd;">${formatarMoeda(totalItem)}</td>
                    </tr>
                `;
            });

            const relatorioHTML = `
                <div class="cabecalho-relatorio" style="display:flex; justify-content:space-between; align-items:flex-start; border-bottom: 2px solid #ddd; padding-bottom: 15px;">
                    <h3 style="color:#1e88e5; font-size: 1.5em; margin: 0;">${dados.tipo}</h3>
                    <div style="text-align: right;">
                        <p style="color:#555; margin: 3px 0;">N¬∫: <strong>${dados.numero}</strong></p>
                        <p style="color:#555; margin: 3px 0;">Data: <strong>${dados.dataDisplay}</strong></p> </div>
                </div>

                <div class="secao dados-emissor" style="margin-top: 20px; border-bottom: 1px dashed #ccc; padding-bottom: 10px;">
                    <h4 style="color:#555; font-size: 1em; margin: 0 0 5px 0;">Emissor</h4>
                    <p style="color:#333; margin: 3px 0;"><strong>${dados.emissor}</strong></p>
                    <p style="color:#555; margin: 3px 0;">CNPJ: ${dados.cnpjEmissor}</p> </div>

                <div class="secao dados-cliente" style="margin-top: 20px; border-bottom: 1px dashed #ccc; padding-bottom: 10px;">
                    <h4 style="color:#555; font-size: 1em; margin: 0 0 5px 0;">Cliente</h4>
                    <p style="color:#333; margin: 3px 0;"><strong>${dados.cliente}</strong></p>
                    <p style="color:#555; margin: 3px 0;">Endere√ßo: ${dados.enderecoCliente}</p> <p style="color:#555; margin: 3px 0;">CPF/CNPJ: ${dados.cpfCliente}</p> </div>

                <div class="secao detalhes-itens-pdf" style="margin-top: 20px;">
                    <h4 style="color:#555; font-size: 1em; margin: 0 0 10px 0;">Detalhes dos Itens/Servi√ßos</h4>
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background-color: #e3f2fd;">
                                <th style="color:#333; padding: 8px; border: 1px solid #ddd;">Descri√ß√£o</th>
                                <th style="color:#333; padding: 8px; border: 1px solid #ddd; text-align: right;">Qtd</th>
                                <th style="text-align: right; color:#333; padding: 8px; border: 1px solid #ddd;">Valor Unit.</th>
                                <th style="text-align: right; color:#333; padding: 8px; border: 1px solid #ddd;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itens.length > 0 ? itensHTML : '<tr><td colspan="4" style="text-align: center; color: #777;">Nenhum item adicionado.</td></tr>'}
                        </tbody>
                    </table>
                </div>

                <div class="detalhes-totais" style="margin-top: 20px; text-align: right; color:#333;">
                    <p style="margin: 5px 0;">Subtotal: ${formatarMoeda(dados.subtotal)}</p>
                    <p style="margin: 5px 0;">Imposto (${dados.impostoPercentual}%): ${formatarMoeda(dados.valorImposto)}</p>
                    <p class="total-final" style="font-size: 1.2em; color: #1e88e5; font-weight: bold; margin: 10px 0;">Total Geral: ${formatarMoeda(dados.totalGeral)}</p>
                </div>

                <div class="rodape-relatorio" style="margin-top: 40px; padding-top: 10px; border-top: 1px dashed #ccc; font-size: 0.8em; text-align: center; color: #777;">
                    <p>Documento gerado em ${dados.dataAtual}. Ferramenta de demonstra√ß√£o.</p>
                </div>
            `;

            document.getElementById('relatorio-pdf').innerHTML = relatorioHTML;
            salvarDados();
        }

        // --- Fun√ß√µes de Persist√™ncia e PDF ---

        function salvarDados() {
            const dados = {
                tipo: document.getElementById('tipo').value,
                numero: document.getElementById('numero').value,
                data: document.getElementById('data').value, // Novo
                cliente: document.getElementById('cliente').value,
                enderecoCliente: document.getElementById('enderecoCliente').value, // Novo
                cpfCliente: document.getElementById('cpfCliente').value, // Novo
                emissor: document.getElementById('emissor').value,
                cnpjEmissor: document.getElementById('cnpjEmissor').value, // Novo
                imposto: document.getElementById('imposto-percentual').value,
                itens: itens,
                proximoId: proximoId
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(dados));
        }

        function carregarDados() {
            carregarTema();

            const dadosJSON = localStorage.getItem(STORAGE_KEY);
            let dados;

            if (dadosJSON) {
                // Se houver dados salvos, carrega eles
                dados = JSON.parse(dadosJSON);
            } else {
                // Se n√£o houver dados salvos, usa os gen√©ricos
                dados = DADOS_GENERICOS;
            }

            // Carrega os dados (salvos ou gen√©ricos)
            document.getElementById('tipo').value = dados.tipo || "";
            document.getElementById('numero').value = dados.numero || "";
            document.getElementById('data').value = dados.data || ""; // Novo
            document.getElementById('cliente').value = dados.cliente || "";
            document.getElementById('enderecoCliente').value = dados.enderecoCliente || ""; // Novo
            document.getElementById('cpfCliente').value = dados.cpfCliente || ""; // Novo
            document.getElementById('emissor').value = dados.emissor || "";
            document.getElementById('cnpjEmissor').value = dados.cnpjEmissor || ""; // Novo
            document.getElementById('imposto-percentual').value = dados.imposto || "";

            itens = dados.itens || [];
            proximoId = dados.proximoId || 1;

            if (itens.length > 0) {
                const maxId = Math.max(...itens.map(item => item.id));
                proximoId = maxId + 1;
            }
            renderizarListaItens();
        }

        function limparTudo() {
            const confirmBox = document.getElementById('confirmacao-dinamica');
            confirmBox.style.display = 'block'; // mostra a confirma√ß√£o

            document.getElementById('btn-confirmar').onclick = () => {
                document.getElementById('formulario-nota').reset();
                itens = []; proximoId = 1;

                // Limpa os novos campos do form e do estado
                document.getElementById('data').value = "";
                document.getElementById('enderecoCliente').value = "";
                document.getElementById('cpfCliente').value = "";
                document.getElementById('cnpjEmissor').value = "";

                renderizarListaItens();
                mostrarMensagem("Todos os dados foram limpos.", "info", 3000);
                confirmBox.style.display = 'none';
            };

            document.getElementById('btn-cancelar').onclick = () => {
                confirmBox.style.display = 'none'; // apenas fecha
                mostrarMensagem("A√ß√£o cancelada.", "info", 2000);
            };
        }

        // Fun√ß√£o placeholder para 'mostrarMensagem' (n√£o estava definida)
        function mostrarMensagem(texto, tipo, tempo) {
            console.log(`[${tipo.toUpperCase()}]: ${texto}`);
        }


        /**
         * üí° NOVA FUN√á√ÉO GERAR PDF (Usando jsPDF puro e autotable)
         * Esta fun√ß√£o constr√≥i o PDF item por item, o que IGNORA as restri√ß√µes de seguran√ßa do file://.
         * Deve funcionar em todos os navegadores, localmente.
         */
        function gerarPDF() {
            const dados = getDadosDocumento();

            // Configura√ß√µes do documento PDF
            const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
            });

            const pageW = doc.internal.pageSize.getWidth();
            let currentY = 15; // Posi√ß√£o Y inicial
            const margin = 15;
            const padding = 5;

            // 1. CABE√áALHO DO DOCUMENTO
            doc.setFontSize(18);
            doc.setTextColor('#1e88e5');
            doc.text(dados.tipo, margin, currentY);

            doc.setFontSize(10);
            doc.setTextColor('#555');
            doc.text(`N¬∫: ${dados.numero}`, pageW - margin, currentY, { align: 'right' });
            currentY += 5;
            doc.text(`Data: ${dados.dataDisplay}`, pageW - margin, currentY, { align: 'right' });
            currentY += 10;

            // Linha separadora
            doc.setDrawColor(220, 220, 220);
            doc.line(margin, currentY, pageW - margin, currentY);
            currentY += 5;

            // 2. DADOS DO EMISSOR
            doc.setFontSize(12);
            doc.setTextColor('#555');
            doc.text('Emissor', margin, currentY);
            currentY += 5;
            doc.setFontSize(10);
            doc.setTextColor('#333');
            doc.text(dados.emissor, margin, currentY);
            currentY += 5;
            doc.setTextColor('#555');
            doc.text(`CNPJ: ${dados.cnpjEmissor}`, margin, currentY);
            currentY += 10;
            doc.line(margin, currentY, pageW - margin, currentY);
            currentY += 5;

            // 3. DADOS DO CLIENTE
            doc.setFontSize(12);
            doc.setTextColor('#555');
            doc.text('Cliente', margin, currentY);
            currentY += 5;
            doc.setFontSize(10);
            doc.setTextColor('#333');
            doc.text(dados.cliente, margin, currentY);
            currentY += 5;
            doc.setTextColor('#555');
            doc.text(`Endere√ßo: ${dados.enderecoCliente}`, margin, currentY);
            currentY += 5;
            doc.text(`CPF/CNPJ: ${dados.cpfCliente}`, margin, currentY);
            currentY += 10;
            doc.line(margin, currentY, pageW - margin, currentY);
            currentY += 5;

            // 4. TABELA DE ITENS (usando autotable)
            doc.setFontSize(12);
            doc.setTextColor('#555');
            doc.text('Detalhes dos Itens/Servi√ßos', margin, currentY);
            currentY += 5;

            // Preparar dados para a tabela
            const head = [['Descri√ß√£o', 'Qtd', 'V. Unit√°rio', 'Total']];
            const body = itens.map(item => [
                item.descricao,
                item.quantidade,
                formatarMoeda(item.valorUnitario),
                formatarMoeda(item.quantidade * item.valorUnitario)
            ]);

            if (itens.length === 0) {
                body.push([{
                    content: 'Nenhum item adicionado.',
                    colSpan: 4,
                    styles: {
                        halign: 'center',
                        fontStyle: 'italic',
                        textColor: [119, 119, 119]
                    }
                }]);
            }

            doc.autoTable({
                startY: currentY,
                head: head,
                body: body,
                theme: 'striped',
                styles: {
                    fontSize: 10,
                    cellPadding: padding / 2,
                    overflow: 'linebreak',
                    textColor: [51, 51, 51]
                },
                headStyles: {
                    fillColor: [227, 242, 253], // #e3f2fd (cor do seu cabe√ßalho)
                    textColor: [51, 51, 51],
                    fontStyle: 'bold',
                    halign: 'center'
                },
                columnStyles: {
                    // Alinhamento das colunas de valor √† direita
                    1: {
                        halign: 'right'
                    },
                    2: {
                        halign: 'right'
                    },
                    3: {
                        halign: 'right'
                    }
                },
                didDrawPage: (data) => {
                    // Atualiza a posi√ß√£o Y ap√≥s a tabela
                    currentY = data.cursor.y + 10;
                }
            });

            // 5. DETALHES DOS TOTAIS

            currentY += 5;
            const xAlign = pageW - margin;

            // Subtotal
            doc.setFontSize(10);
            doc.setTextColor('#333');
            doc.text(`Subtotal: ${formatarMoeda(dados.subtotal)}`, xAlign, currentY, { align: 'right' });
            currentY += 5;

            // Imposto
            doc.text(`Imposto (${dados.impostoPercentual}%): ${formatarMoeda(dados.valorImposto)}`, xAlign, currentY, { align: 'right' });
            currentY += 8;

            // Total Geral
            doc.setFontSize(12);
            doc.setTextColor('#1e88e5');
            doc.text(`Total Geral: ${formatarMoeda(dados.totalGeral)}`, xAlign, currentY, { align: 'right' });
            currentY += 10;


            // 6. RODAP√â
            doc.setDrawColor(204, 204, 204);
            doc.line(margin, doc.internal.pageSize.getHeight() - 15, pageW - margin, doc.internal.pageSize.getHeight() - 15);
            doc.setFontSize(8);
            doc.setTextColor('#777');
            doc.text(`Documento gerado em ${dados.dataAtual}. Ferramenta de demonstra√ß√£o.`, pageW / 2, doc.internal.pageSize.getHeight() - 10, { align: 'center' });

            // Salva o PDF
            doc.save(`${dados.tipo.replace(/\s/g, '_')}_${dados.numero}.pdf`);
        }


        // Inicializa a aplica√ß√£o ao carregar a p√°gina (carrega dados e tema)
        document.addEventListener('DOMContentLoaded', carregarDados);
    </script>

</body>

</html>
